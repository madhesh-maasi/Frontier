"use strict";
/**
 * @file createPackage.ts
 * @Copyright (c) Microsoft Corporation.  All rights reserved.
 *
 * Creates a client-side app package and writes it to disk
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const node_core_library_1 = require("@rushstack/node-core-library");
const normalizeSolutionDefinition_1 = __importDefault(require("./utils/normalizeSolutionDefinition"));
const createSolutionXml_1 = __importDefault(require("./xmlGenerators/createSolutionXml"));
const readCustomFeatures_1 = __importDefault(require("./utils/readCustomFeatures"));
const validateSolutionDefinition_1 = require("./utils/validateSolutionDefinition");
const readResources_1 = __importDefault(require("./utils/readResources"));
const writePackage_1 = __importDefault(require("./writePackage"));
/**
 * Creates and writes a package to disk using a package definition and manifest mapping
 */
function createPackage(terminal, config, manifests) {
    // @todo instead of using try/catch we should move config validation to a separate function
    try {
        terminal.writeLine(node_core_library_1.Colors.yellow('Verifying configuration...'));
        if (!manifests || !manifests.size) {
            throw new Error('The webparts manifests list is empty. ' +
                'Please ensure you have done a build and that your config file is pointed at the correct folder.');
        }
        if (!config.paths.zippedPackage || config.paths.zippedPackage === '') {
            throw new Error('The package-solution.json config is missing a package name.');
        }
        terminal.writeLine(node_core_library_1.Colors.green('Done!'));
        terminal.writeLine();
        terminal.writeLine(node_core_library_1.Colors.yellow('Normalizing solution information...'));
        normalizeSolutionDefinition_1.default(terminal, config, manifests);
        terminal.writeLine(node_core_library_1.Colors.green('Done!'));
        terminal.writeLine();
        terminal.writeLine(node_core_library_1.Colors.yellow('Reading custom Feature XML...'));
        return readCustomFeatures_1.default(terminal, config).then((customFeatures) => {
            terminal.writeLine(node_core_library_1.Colors.green('Done!'));
            terminal.writeLine();
            terminal.writeLine(node_core_library_1.Colors.yellow('Validating App Package...'));
            validateSolutionDefinition_1.validateSolutionDefinition(terminal, config, customFeatures, manifests);
            terminal.writeLine(node_core_library_1.Colors.green('Done!'));
            terminal.writeLine();
            terminal.writeLine(node_core_library_1.Colors.yellow('Reading resources...'));
            return readResources_1.default(terminal, config).then((resources) => {
                terminal.writeLine(node_core_library_1.Colors.green('Done!'));
                terminal.writeLine();
                terminal.writeLine(node_core_library_1.Colors.yellow('Reading Sharepoint Assets & Creating XML...'));
                const solutionXml = createSolutionXml_1.default(terminal, config.solution, customFeatures.customFeatureFilepath, resources, config.contentTypes);
                terminal.writeLine(node_core_library_1.Colors.green('Done!'));
                terminal.writeLine();
                solutionXml.customFiles = customFeatures.files;
                terminal.writeLine(node_core_library_1.Colors.yellow(`Writing solution XML to ${config.paths.debugDir}...`));
                return writePackage_1.default(terminal, solutionXml, config).then(() => {
                    terminal.writeLine(node_core_library_1.Colors.green('Done!'));
                    terminal.writeLine();
                    terminal.writeLine(node_core_library_1.Colors.bold(node_core_library_1.Colors.green('ALL DONE!')));
                    terminal.writeLine();
                }, (error) => {
                    terminal.writeErrorLine(node_core_library_1.Colors.red(error));
                });
            }, (error) => {
                terminal.writeErrorLine(node_core_library_1.Colors.red(error));
            });
        }, (error) => {
            terminal.writeErrorLine(node_core_library_1.Colors.red(error));
        });
    }
    catch (error) {
        terminal.writeErrorLine(node_core_library_1.Colors.red(error));
        if (error.stack) {
            terminal.writeErrorLine(error.stack);
        }
        return Promise.reject(error);
    }
}
exports.default = createPackage;
//# sourceMappingURL=createPackage.js.map